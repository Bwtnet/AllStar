#! /bin/sh

# Revision: .000000002
# refrenced from:
# <http://odroid.com/dokuwiki/doku.php?id=en:c1_building_kernel>

apt-get install ntp -y
dpkg-reconfigure tzdata

# Not sure any of this is needed
cd /etc/apt/sources.list.d/
wget http://oph.mdrjr.net/meveric/sources.lists/meveric-all-C1.list
wget -O- http://oph.mdrjr.net/meveric/meveric.asc | apt-key add -
apt-get update

# install the required tools
apt-get install uboot-mkimage -y
apt-get install ncurses-dev -y
apt-get install bc -y
apt-get install lzop -y

apt-get install g++ -y
apt-get install make -y
apt-get install build-essential -y
apt-get install subversion -y
apt-get install git -y

# I don't think this is needed
# apt-get install linux-headers-armhf-odroid-c1 -y

cd /srv
git clone --depth 1 https://github.com/hardkernel/linux.git -b odroidc-3.10.y
cd linux

# Build The kernel

make odroidc_defconfig
make menuconfig
# or copy pre-created .config
make -j4
make -j4 modules
make uImage
make dtbs

# Installation
# I don't think ARCH=arm is needed, but it does not hurt anything
make modules_install ARCH=arm INSTALL_MOD_PATH=/

# Backup boot files
# The boot partition needs to be RW
mount -o remount,rw /boot

mkdir /srv/new_boot
mkdir /srv/back_boot

mv /boot/meson8b_odroidc.dtb /srv/back_boot/meson8b_odroidc.dtb
mv /boot/uImage /srv/back_boot/uImage
mv /boot/uInitrd /srv/back_boot/uInitrd

# Install new boot files
cp arch/arm/boot/dts/meson8b_odroidc.dtb /srv/new_boot
cp arch/arm/boot/uImage /srv/new_boot

update-initramfs -c -k 3.10.67 -b /srv/new_boot
mkimage -A arm -O linux -T ramdisk -C none -a 0 -e 0 -n uInitrd -d /srv/new_boot/initrd.img-3.10.67 /srv/new_boot/uInitrd-3.10.67

cp /srv/new_boot/meson8b_odroidc.dtb /boot/meson8b_odroidc.dtb
cp /srv/new_boot/uImage /boot/uImage
cp /srv/new_boot/uInitrd-3.10.67 /boot/uInitrd

# update-initramfs -c -k `uname -r`
# mkimage -A arm -O linux -T ramdisk -C none -a 0 -e 0 -n uInitrd -d /boot/initrd.img-`uname -r` /boot/uInitrd-`uname -r`

